<!-- Interfaz para el inicio de sesión-->
<!--Paleta de colores utilizada en la interfaz 
        Texto dentro de los botones - 
        botones - #4EABE0 26% opacidad 
        Letra de botones - #818798
        botones de confirmacion - #0B6380
        Fondo - 

    Tipo de Letra
        Letra para titulos - Poppins Bold 60
        letra para textos - Poppins regular 30 -->
    
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empreverest</title>

    <!-- Referencias para archivos locales-->
    <link rel = "stylesheet" href="styles/style_login.css">
    <link rel = "stylesheet" href="src-ico/empreverest.svg">

    <!-- Referencia para Bootstrap-->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="js/bootstrap.bundle.min.js"></script>

    <!-- Referencia para BoxIcons-->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <!-- Referencia para AwesomeFont-->
    <link href="/your-path-to-fontawesome/css/fontawesome.css" rel="stylesheet">
    <link href="/your-path-to-fontawesome/css/brands.css" rel="stylesheet">
    <link href="/your-path-to-fontawesome/css/solid.css" rel="stylesheet">

    <!-- Favicon-->
    <link rel="icon" href="src-ico/empreverest.svg" type="image/x-icon">

    <!-- Referencia para la API de Google-->
    <script src="https://www.google.com/recaptcha/api.js?render=6LeriJspAAAAAD_UGlSansdlmb6cKYvYWku9dRuG"></script>
  </head>

<body>

  <!-- Icono para regresar a la pagina principal-->
  <div class="contenedor">
    <a href="index.html" class="etiqueta">
      <button class="botonAtras" type="button">
        <img src="src-ico/empreverest.svg" alt="Empreverest">
      </button>
    </a>
  </div>

  <div class="fullbox">

    <!-- Formulario para la interfaz de inicio de sesión
      - Ingresar un correo electrónico  
      - Validar si el correo electrónico se encuentra en la base de datos 
      - Ingresar una contraseña
      - Validar si la contraseña coincide-->
    <form id="form-login" action="val_login.php" method="post">
      
      <!-- Titulo principal-->
      <h1>Iniciar Sesión</h1>
      
      <!-- Caja para ingresar el correo electronico-->
      <div class="input-box">
        <label for="exampleFormControlInput1" class="form-label">Correo electrónico</label>
        <input type="email" class="form-control" id="correoelectronico" name="correoelectronico" placeholder="Correo electrónico" pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\.udg\.mx$" required>        
        <i class='bx bx-user'></i>
      </div>

      <!-- Caja para ingresar la contraseña-->
      <div class="input-box">
        <label for="inputPassword5" class="form-label">Contraseña</label>
        <input type="password" id="contraseña" class="form-control" name="contraseña" aria-describedby="passwordHelpBlock" placeholder="Contraseña" required> 
        <div id="passwordHelpBlock" class="form-text"></div>
        <i id="togglePassword" class='bx bx-lock-alt'></i> 
      </div>

      <!-- Link en caso de que el usuario halla olvidado la contraseña-->
      <div class="olvidarContraseña">
          <a href="email.html">¿Olvidaste tu contraseña?</a>
      </div>

      <!--Boton para iniciar sesion-->
      <button type="submit" id="entrar" class="botonIniciarSesion">Iniciar Sesión</button>
      
      <hr> <!--Colocar linea -->

      <!--Boton para iniciar sesion con Google-->
      <button class="botonGoogle" button type="button"> <img src="src-ico/google.png" style="width: 30px; margin-right: 10px;">
        Iniciar sesión con Google
      </button>

      <div class="registrarse">
        <p>¿No tienes una cuenta? <a href="Registrarse.html">Regístrate</a> </p>
      </div>

    </form> <!--Fin del formulario, ya no se reciben más entradas-->
  </div>

  <div class="contenedorCentrado" style="text-align: center;">
    <div style="display: inline-block;"> <!-- Div para centrar contenido -->
      <img src="src-ico/empreverest.svg" style="width: 300px; margin-bottom: -30px;" alt="Empreverest">
      <span style="display: block;">EMPREVEREST</span>
    </div>
  </div>

</body>
</html>

<!-- Toast | Mensajes para el usuario en caso de error-->
<div role="alert" id="loginToast" aria-live="assertive" aria-atomic="true" class="toast" data-bs-autohide="true">
  <div class="toast-header">
    <img src="src-ico/empreverest.svg" class="rounded me-2" alt="Empreverest">
    <strong class="me-auto">Error de inicio de sesion</strong>
    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
  </div>
  <div class="toast-body">
    Mensaje al usuario
  </div>
</div>

<!-- Toast | Mensajes para el usuario en caso de cambio de contraseña-->
<div role="alert" id="passwordToast" aria-live="assertive" aria-atomic="true" class="toast" data-bs-autohide="true">
  <div class="toast-header">
    <img src="src-ico/empreverest.svg" class="rounded me-2" alt="Empreverest">
    <strong class="me-auto">Cambio de contraseña</strong>
    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
  </div>
  <div class="toast-body">
    La contraseña fue actualizada correctamente
  </div>
</div>

<!-- Alternar iconos para mostrar y esconder la contraseña-->
<script>
  // Función para alternar entre contraseña visible y oculta
  document.getElementById('togglePassword').addEventListener('click', function() { //Evento al realizar un clic en "TogglePassword (el icono de candado cerrado)"
    var passwordInput = document.getElementById('contraseña'); //Obtener la contraseña
    var toggleIcon = document.getElementById('togglePassword'); //Obtener el icono

    if (passwordInput.type === 'password') { //Verificar si el tipo de entrada es de contraseña
      passwordInput.type = 'text'; //Convertir el tipo de entrada a texto
      toggleIcon.classList.remove('bx-lock-alt'); //Quitar el icono con candado cerrado
      toggleIcon.classList.add('bx-lock-open-alt'); //Colocar el icono con candado abierto 
    } else { //Entonces el tipo de entrada no es de contraseña
      passwordInput.type = 'password'; //Convertir el tipo de entrada a contraseña
      toggleIcon.classList.remove('bx-lock-open-alt'); //Quitar el icono con candado cerrado
      toggleIcon.classList.add('bx-lock-alt'); //Colocar el icono con candado abierto 
    }
  });
</script>

<script>
  // Obtener los parámetros de la URL
  const urlParams = new URLSearchParams(window.location.search); //Buscar la URL actual 
  const loginStatus = urlParams.get('login');
  const errorType = urlParams.get('error');

  // Función para mostrar el toast de error
  function showToast() {
      const toastEl = document.getElementById('loginToast');
      const toast = new bootstrap.Toast(toastEl);
      toast.show();
  }
  // Función para mostrar el toast de cambio de contraseña
  function showpasswordToast() {
      const toastpassword = document.getElementById('passwordToast');
      const toastpass = new bootstrap.Toast(toastpassword);
      toastpass.show();
  }

  // Mostrar el toast correspondiente según el parámetro de error
  if (loginStatus === 'fail') { // Contraseña incorrecta
      if(loginStatus === 'fail' && errorType === 'bad_passwords') { //Validar si la contraseña ingresada contiene caracteres inválidos
        document.querySelector('.toast-body').innerText = 'La contraseña ingresada contiene caractéres no válidos. Por favor intente de nuevo';
        showToast(); //Mostrat el toast
      } else if (errorType === 'incorrect_credentials') {
          document.querySelector('.toast-body').innerText = 'Contraseña o usuario incorrecto';
          showToast();
      } else if (errorType === 'short_password') { // Usuario no registrado
          document.querySelector('.toast-body').innerText = 'La contraseña debe de tener al menos 8 caracteres';
          showToast();
      } else if (errorType === 'not_registered') { // Usuario no registrado
          document.querySelector('.toast-body').innerText = 'El usuario no está registrado';
          showToast();
      } else if (errorType === 'invalid_email') { // Correo electrónico inválido
          document.querySelector('.toast-body').innerText = 'El correo electrónico ingresado no es válido';
          showToast();
      }
  } else if(loginStatus === 'password_updated') { //Validar si se hizo un cambio de contraseña
    document.querySelector('.toast-body').innerText = 'La contraseña fue actualizada correctamente';
    showpasswordToast();
  }
</script>

<script>
  $(document).ready(function() {
    $('#entrar').click(function(){
      grecaptcha.ready(function() {
        grecaptcha.execute('6LeriJspAAAAAD_UGlSansdlmb6cKYvYWku9dRuG', {action: 'validarUsuario'}).then(function(token) {
          $('#form-login').prepend('<input type="hidden" name="token" value="' + token + '">');
          $('#form-login').prepend('<input type="hidden" name="action" value="validarUsuario">');
          $('#form-login').submit();
        });
      });
    });

  });
</script>
